name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Core package tests
  core:
    runs-on: ubuntu-latest
    name: Core Package
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: TypeScript check
        run: cd packages/core && bun run tsc --noEmit

      - name: Run unit tests
        run: cd packages/core && bun test
        continue-on-error: true

  # Desktop app build and tests (Tauri)
  desktop:
    runs-on: ubuntu-latest
    name: Desktop App (Tauri)
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies (Tauri)
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: TypeScript check
        run: cd apps/desktop && bun run tsc --noEmit
        continue-on-error: true

      - name: Run tests
        run: cd apps/desktop && bun test
        continue-on-error: true

      - name: Build Vite frontend
        run: cd apps/desktop && bun run build:vite

      - name: Build Tauri app (debug, no bundle)
        run: cd apps/desktop && cargo tauri build --debug --no-bundle
        continue-on-error: true

  # Mobile app validation
  mobile:
    runs-on: ubuntu-latest
    name: Mobile App
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: TypeScript check
        run: cd apps/mobile && bunx tsc --noEmit
        continue-on-error: true

      - name: Expo Doctor check
        run: cd apps/mobile && bunx expo-doctor
        continue-on-error: true

  # Lint check
  lint:
    runs-on: ubuntu-latest
    name: Code Quality
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Check for lint errors (mobile)
        run: cd apps/mobile && bun run lint
        continue-on-error: true
