name: Build Windows MSIX

on:
  workflow_dispatch:

jobs:
  build-msix:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install Tauri CLI
        run: cargo install tauri-cli --version "^2.0"

      - name: Install dependencies
        run: bun install

      - name: Create Dummy Certificate
        run: |
          $cert = New-SelfSignedCertificate -Type Custom -Subject "CN=MindwtrTest" -KeyUsage DigitalSignature -FriendlyName "MindwtrTest" -CertStoreLocation "Cert:\CurrentUser\My" -TextExtension @("2.5.29.37={text}1.3.6.1.5.5.7.3.3", "2.5.29.19={text}")
          $password = ConvertTo-SecureString -String "password123" -Force -AsPlainText
          Export-PfxCertificate -Cert $cert -FilePath "dummy.pfx" -Password $password
        shell: powershell

      - name: Build MSIX
        env:
          TAURI_WINDOWS_MSIX_CERTIFICATE_PATH: "dummy.pfx"
          TAURI_WINDOWS_MSIX_CERTIFICATE_PASSWORD: "password123"
        run: |
          cd apps/desktop
          cargo tauri build --target msix

      - name: Upload MSIX
        uses: actions/upload-artifact@v4
        with:
          name: mindwtr-msix
          path: apps/desktop/src-tauri/target/release/bundle/msix/*.msix
